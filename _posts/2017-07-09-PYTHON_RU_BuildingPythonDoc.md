---
title: Сборка документации для CPython
layout: default
---

В свободное время я люблю иногда посидеть и посмотреть что находится под капотом CPython и как оно работает. Сегодня хочу глянуть на 
директорию Doc. Хочу предупредить, содержимое поста сыроватое, используется просто как некая памятка для меня.

CPython репозиторий содержит такую папку как Doc. В ней хранится вся документация о Питоне. Разумеется, собирать ее не нужно.
Собранная версия уже расположена на сайте Питона по адресу <https://docs.python.org/dev/download.html>. 
Но мне ради интереса захотелось немного "поковыряться" в ней.
Итак, все данные организованны по темам (насколько правильно я понял структуру файлов):
1) c-api
2) data
3) distributing
4) distutils
5) extending
6) faq
7) howto
8) includes
9) installing
10) library
11) reference
12) tools
13) tutorial
14) using
15) whatsnew

Все файлы, содержащие текст документации хранятся в формате rst (reStructuredText) - это формат специально разработан 
для документации Питона. Каждый из файлов в таком формате специально обрабатывается программой Sphinx (специально разработана
для обработки таких файлов). Поэтому чтобы собрать документацию нужно скачать программу 
Sphinx <http://sphinx-doc.org/> и использовать ее (разработка и поддержка этой программы ведется в отдельной ветке).

Собрать документацию можно двумя способами (в обоих случаях запуск идет из консоли и директории Doc):

1) Установить sphinx-build пакет и запустить команду sphinx-build -b<builder> . build/<builder>, где <builder> - 
это просто тип тагрета (формата) документации {html, text, latex, or htmlhelp}.

2) Просто использовать команду make (опять же, так как существует зависимость от sphinx, то нужно сперва скачать этот пакет). 
Структура команды make такая - make format [PYTHON=python3] [SPHINXBUILD=sphinx-build], где: 

a) формат (приведу небольшую часть - если нужно подробнее смотри файл ReadMe.md в корне директории Doc):

    * "clean" - очистка билд файлов

    * "html" - одиночный файл html, для оффлайн просмотра

    * "htmlview" - то же что и html, но после сборки автоматически открывает ваш дефолт браузер

    * "htmlhelp" - строит html файл + проектый файл html help, который используется для компиляции всего в один 
    Compiled HTML (.chm) файл (чтобы его создать нужно использовать Microsoft HTML Help Workshop) - разумеется команда make 
    все это сделает за вас (я имею ввиду OS Windows)

    * "latex"- формат для tex'a

    * "text" - обычный простой формат

    * "epub" - формат для электронных книг
    
b) PYTHON - содержить путь до используемого интерпретатора (для работы с .py файлами)

с) SPHINXBUILD - содержит путь до использумого .rst процессора (для работы .rst файлов)

Насколько я понимаю, чтобы юниформно работать с командой make как на Windows так и на UNIX машинах, разработчики CPython 
пошли таким образом - просто поставляют makefile для Unix, и make.bat файл для Windows.

Сейчас бегло глянем как работает make.bat (На данный момент я работаю на машине с OS WINDOWS). 

1) Инициализация переменных "%SPH INXBUILD%, "%PYTHON%" в sphinx-build и py (в случае отсутсвия значений)

2) В случае наличия команды htmlhelp или неправильного пути в переменной %HTMLHELP% происходит поиск программы hhc.exe 
чтобы была возможность скомпилировать html help проектный файл, найденный путь к программе сохраняется в %HTMLHELP%, иначе 
вывод сообщения об ошибке и выход

3) Настройка имени билд папки и номер дистрибутива PYTHON

4) Если можем обработать команду без Sphinx, то выполняем необходимые шаги (такие как help, check, serve, clean) и заканчиваем 
выполнение файла. (команды check/serve используют py файлы)

5) Проверяем наличие правильно установленого пути %SPHINXBUILD% к процессору .rst файлов, в случае ошибки завершаем выполнение файла

6) Если опция htmlview, то запускаем снова программу с опцией html, затем открываем полученный файл с помощью браузера

7) Иначе производим настройку переменных Sphinx, и производим запуск Sphinx, в случае установки htmlhelp, запускаем hhp.exe чтобы
скомпилировать .chm файл

В общем так и работает первоначальная стадия сборки документации CPython, как видно тут ключевую роль играет Sphinx, вся работа make команды
это просто обвязка на вызов этого процессора .rst файлов.

Небольшые замечания: 

1) Запуск Sphinx происходит при помощи команды:
    
    %SPHINXBUILD% %SPHINXOPTS% -b%1 -dbuild\doctrees . %BUILDDIR%\%* - грубо говоря это и есть первый способ сборки документации.
    
2) Скрипты для запуска некоторых функций подцепляются из папки CPython/Tools/scripts